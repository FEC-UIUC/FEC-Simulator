<html>
<head>
<title>Financial Engineering Club at Illinois | FEC | Home</title>
<link href='http://fonts.googleapis.com/css?family=Roboto+Slab:400,300,700,100' rel='stylesheet' type='text/css'>
<link href='http://fec.ec.illinois.edu/main/css/style.css' rel='stylesheet' type='text/css'>
<style>
    .order-entry-col{
        float: left;
    }
</style>
<!--<script src="//code.jquery.com/jquery-1.11.0.min.js"></script>
<script src="//code.jquery.com/jquery-migrate-1.2.1.min.js"></script> -->
<script src="js/include/jquery-1.11.2.min.js"></script>
<script src="js/include/jquery-migrate-1.2.1.min.js"></script>
<script src="http://code.highcharts.com/stock/highstock.js"></script>
<script src="http://code.highcharts.com/stock/modules/exporting.js"></script>
<script src="js/security_chart.js"></script>
<script>
        $(function(){
            $('#header').load("http://fec.ec.illinois.edu/header.php");
            messages = document.getElementById("messages");
            makeChart();
        });
        
        var webSocket;
        var messages;
        var username = "rickjames123";
        var money = 0;
        var orderID = 1;
        
        var securities = {};
        var orders = {};

        function openSocket(){
            if(webSocket !== undefined && webSocket.readyState !== WebSocket.CLOSED){
               writeResponse("WebSocket is already opened.");
               return;
            }

            webSocket = new WebSocket("ws://localhost:8080/Simulator/server");

            webSocket.onopen = function(event){
                    if(event.data === undefined)
                            return;
                    writeResponse(event.data);
            };

            webSocket.onmessage = messageHandler;

            webSocket.onclose = function(event){
                writeResponse("Connection closed");
            };
            
            //TODO - send new_user and handle new_user response
            
        }
        
        function messageHandler(event){
            var msg = parseMessage(event.data);
            if(msg['message_type'] === 'message'){
               m = "<b>" + msg['from'] + ":</b> " + msg['message']; 
               writeResponse(m);
            } 
            else if (msg['message_type'] === 'order'){
                handleOrder(msg);
            } 
            else if (msg['message_type'] ==='cancel'){
                handleCancel(msg);
            } 
            else if (msg['message_type'] ==='snapshot'){
                handleSnapshot(msg);
            } 
        }
        
        function parseMessage(message_string) {
            var message = {};
            var pairs = message_string.split("|");
            for(var i=0; i < pairs.length; i++){
                var key_val = pairs[i].split("=", 2);
                message[key_val[0]] = key_val[1];
            }
            return message;
        }
        
        function formatMessage(message_map) {
            var message_string = "";
            for(var key in message_map){
                message_string += key + "=" + message_map[key] + "|";
            }
            return message_string.slice(0, -1);
        }

        function startData(){
           webSocket.send("message_type=admin|command=start");
        }

        function stopData(){
           webSocket.send("message_type=admin|command=stop");
        }

        function sendMessage(){
                var message_text = document.getElementById("messageinput").value;
                msg = {
                    "type" : "message",
                    "from" : username,
                    "message" : message_text
                }
                webSocket.send(formatMessage(msg));
        }

        function closeSocket(){
                webSocket.close();
        }

        function writeResponse(text){
                messages.innerHTML += "<br/>" + text;
        }

        function clearFeed(){
            messages.innerHTML = "<br/>" 
        }


        function handleOrder(msg){

            if(!orders.hasOwnProperty(parseInt(msg["orderID"]))){
              writeResponse("Got order " + msg["orderID"] + ", what the hell.");
              return;
            }
            
            money += parseInt(msg["money"]);
            
            order = orders[msg["orderID"]];
            order["remaining"] = parseInt(msg["remaining"]);
            order["filled"] += parseInt(msg["filled"]);
            
            var side = (order["side"] == "BUY") ? 1 : -1;
            securities[msg["symbol"]]['position'] += parseInt(msg["filled"]) * side;
            var action = parseInt(msg["action"]);
            
            if(action === 0){
                writeResponse("Order " + msg["orderID"] + "was filled for " + msg["money"]/100);
                order["status"] = "Filled";
            } 
            else if(action === 1){
                writeResponse("Order " + msg["orderID"] + "was partially filled for " + msg["money"]/100 + " and has " + msg["remaining"] + " remaining");
                order["status"] = "Partial Filled";
            } 
            else if(action === 2){
                writeResponse("Order " + msg["orderID"] + "was successfully placed");
                order["status"] = "Resting";
            } 
            else if(action === 3){
                writeResponse("Order " + msg["orderID"] + "was canceled");
                order["status"] = "Canceled";
            }
            
            orders[msg["orderID"]] = order;
            
            updateCurrentOrdersTable(order);
            
        }


        function sendCancel(orderID){
            if(orderID != null){
                writeResponse("Sending cancel order for " + orderID);
                var msg = {
                    "type" : "cancel",
                    "orderID" : orderID
                }
                webSocket.send(formatMessage(msg));
            }
        }
        
        function handleCancel(msg){
            if(!orders.hasOwnProperty(msg["orderID"])){
                writeResponse("Got order " + msg["orderID"] + ", what the hell.");
                return;
            }
            if(msg["success"] == 0){
                writeResponse("Cancel Failed on order " + msg["orderID"]);
            } else if(msg["success"] == 1){
                writeResponse("Cancel Success on order " + msg["orderID"]);
                orders[msg["orderID"]]["status"] = "Canceled";
                updateCurrentOrdersTable(orders[msg["orderID"]]);
            }
        }


        var chart_security = "GOOG";
        function handleSnapshot(msg){

            if(!securities.hasOwnProperty(msg['symbol'])){
                securities[msg['symbol']] = {
                    'price_series' : [],
                    'volume_series' : [],
                    'bid_price' : 0,
                    'ask_price' : 0,
                    'bid_qty' : 0,
                    'ask_qty' : 0,
                    "last_price" : 0,
                    'position' : 0,
                    'paid' : 0,
                    'value' : 0,
                    "total_pnl" : 0,
                    'tablepointer' : null
                };
            } 

            var t = (new Date()).getTime()
            var bid_price = parseInt(msg['bid_price'])/100;
            var ask_price = parseInt(msg['ask_price'])/100;
            var last_price = parseInt(msg['last_price'])/100;
            var bid_qty = parseInt(msg['bid_qty']);
            var ask_qty = parseInt(msg['ask_qty']);
            var open_price = (bid_price+ask_price)/2;
            var close_price = (bid_price+ask_price)/2;
            
            securities[msg['symbol']]['price_series'].push([t, open_price]);
            securities[msg['symbol']]['volume_series'].push([t,bid_qty+ask_qty]);
            securities[msg['symbol']]['value'] = securities['position'] * open_price;
            securities[msg['symbol']]['bid_price'] = bid_price;
            securities[msg['symbol']]['ask_price'] = ask_price;
            securities[msg['symbol']]['bid_qty'] = bid_qty;
            securities[msg['symbol']]['ask_qty'] = ask_qty;
            securities[msg['symbol']]['last_price'] = last_price;
            securities[msg['symbol']]['total_pnl'] += securities[msg['symbol']]['value'] - securities[msg['symbol']]['paid']; 
            
            var bar = [open_price, open_price+1, close_price-1, close_price];
            
            if(msg['symbol'] == chart_security){
                stockchart.series[0].addPoint([t,bar], true, true);
                stockchart.series[1].addPoint([t,bid_qty+ask_qty], true, true);
                $("#price-box").html(open_price.toString());
            }
            
            writeResponse(msg["symbol"] + " Bid: " + msg["bid_price"] + "Quantity: " + msg["bid_qty"] + "Ask: " + msg["ask_price"] + "Quantity: " + msg["ask_qty"]);
        
        }


        function sendOrder(){
            var symbol = document.getElementById("orderstock").value;
            var quantity = document.getElementById("ordernumber").value;
            var price = document.getElementById("orderprice").value*100;
            var a = document.getElementById("BuySell");
            var BS = a.options[a.selectedIndex].value;
            var order_types = document.getElementById("OrderType");
            var order_type = order_types.options[order_types.selectedIndex].value;
            var message = {
                "type" : "order",
                "symbol" : symbol,
                "price" : price,
                "side" : BS,
                "quantity" : quantity,
                "order_type" : order_type,
                "orderID" : orderID,
            }
            
            if(price > 0){
                webSocket.send(formatMessage(message));
                orders[orderID] = {
                    "symbol" : symbol,
                    "price" : parseInt(price),
                    "side" : (parseInt(BS) == 0) ? "BUY" : "SELL",
                    "order_type" : parseInt(order_type),
                    "filled" : 0,
                    "remaining" : parseInt(quantity),
                    "status" : "Pending",
                    "tablepointer" : null
                };
                updateCurrentOrdersTable(orders[orderID]);
            } else {
                writeResponse("Invalid Parameters for Order");
            }
            orderID++;            
        }
        
        
        orderStatusStyleMap = {
            "Pending" : "background-color:grey;",
            "Resting" : "background-color:white;",
            "Partial Filled" : "background-color:yellow;",
            "Filled" : "background-color:green;",
            "Canceled" : "background-color:red;"
        }
        
        
        function updateCurrentOrdersTable(order){
            
            var order_row = order["tablepointer"]; 
            
            if(order_row == null){
                order_row = $(".current-orders-row").clone();
                order_row.attr("id", "order-row-" + order["orderID"].toString());
                order["tablepointer"] = order_row;
                $("#current-orders-tbody").append(order_row);
            }
            
            for(key in order){
              if(key != "status" || key != "tablepointer"){
                order_row.find("." + key).html(order[key]);   
              }
            }
            
            order_row.attr("style", orderStatusStyleMap[order["status"]]);
            
            var cancel_order_button = order_row.find(".cancel-order").find("button");
            //cancel_order_button.attr("id", "cancel-order-button-" + order["orderID"].toString())
            cancel_order_button.click(function(e){ sendCancel(order["orderID"]);});
        }
        
        
        function removeFromCurrentOrdersTable(order){
            var order_row = order["tablepointer"];
            var order_row_id = "order-row-" + order["orderID"].toString();
            $("#current-orders-tbody").remove("#" + order_row_id);
        }

        
        function updateSecurityTable(security) {
            var security_row = security["tablepointer"];
            
            if (security_row == null) {
                security_row = $(".securities-row").clone();
                security_row.attr("id", "security-row-" + order["symbol"]);
                order["tablepointer"] = security_row;
                $("#securities-tbody").append(security_row);
            }
            
            for(key in security){
              if(key != "price_series" || key != "volume_series" || key != "tablepointer"){
                security_row.find("." + key).html(security[key]);   
              }
            }

            security_row.find(".unrealized_pnl").html(security['value'] - security['paid']);
            
            var open_button = order_row.find(".open-order-window").find("button");
            open_button.click(function(e){ openOrderWindow(security["symbol"]);});    
        }
        
        
        function removeFromSecuritiesTable(security){
            var security_row_id = "order-row-" + security["symbol"].toString();
            $("#securities-tbody").remove("#" + security_row_id);
        }
        
        
	</script>
</head>
<body>
  <div id="header"></div>
  <div id="content">
  <br>
  <span id="form-notification"></span><br> 
  <br>
  
  <div id="chart-area">
      
  </div>
  
  <div id="order-entry" class="form-row">
    <div class="order-entry-col">
      <label for="orderstock">Stock to Order</label>
      <input type="text" id="orderstock"/> <br>

      <label for="ordernumber">Number to Order</label>
      <input type="text" id="ordernumber"/> <br>

      <label for="orderprice">Price to Pay</label>
      <input type="text" id="orderprice"/> <br>

      <select id="BuySell" size="2">
        <option selected="selected" value="0">Buy</option>
        <option value="1">Sell</option>
      </select>
      
      <select id="OrderType" size="2">
        <option selected="selected" value="0">Market Order</option>
        <option value="1">Limit Order</option>
      </select>
      
      <button type="button" onclick="sendOrder();" >Send Order</button>
      
    </div>
    <div class="order-entry-col">
	
    </div>
  </div>
  
  
  <div class="form-row">
      
      <div class="form-col">
        <table id="securities-table">
            <thead><th>Symbol</th> <th>Order Window</th> <th>Best Bid</th> <th>Best Ask</th> <th>Bid Qty</th> <th>Ask Qty</th> 
            <th>Position</th> <th>Paid</th> <th>Value</th> <th>Unrealized P&L</th> <th>Total P&L</th> </thead>
            <tbody id="securities-tbody"></tbody>
        </table>
      </div>
      
      
      <div class="form-col">
        <table id="current-orders-table">
            <thead><th>OrderID</th> <th>Symbol</th> <th>Side</th> <th>Order Type</th> <th>Price</th> <th>Remaining</th> <th>Filled</th></thead>
            <tbody id="current-orders-tbody"></tbody>
        </table>
      </div>
      
  </div>
  
  <div class="form-row">
	<button type="button" onclick="openSocket();" >Open</button>
	<button type="button" onclick="sendMessage();" >Send Message</button>
	<button type="button" onclick="closeSocket();" >Close</button> <br>
	<button type="button" onclick="startData();" >Start</button>
	<button type="button" onclick="stopData();" >Stop</button>
        <button type="button" onclick="showHistory();" >See Order History</button>
        <button type="button" onclick="clearFeed();" >Clear Feed</button>
  </div>
  
  <div id="chat-area">
    <label for="messageinput">Message</label>
    <input type="text" id="messageinput"/>
  </div>
    
<div id="price-box" style="float:left;border:1;">
</div>
<br>
<!-- Server responses get written here -->
<div id="messages"></div>

</div>
 
 
  
<div id="templates" style="visible:hidden;">
    
        <tr class="current-orders-row">
            <td class="orderID"></td>
            <td class="symbol"></td>
            <td class="side"></td>
            <td class="order_type"></td>
            <td class="price"></td>
            <td class="remaining"></td>
            <td class="filled"></td>
            <td class="order-cancel">
                <button type="button">Cancel Order</button>
            </td>
        </tr>
        
        <tr class="securities-row">
            <td class="symbol"></td>
            <td class="open-order-window">
                <button type="button">Open</button>
            </td>
            <td class="bid_price"></td>
            <td class="ask_price"></td>
            <td class="last_price"></td>
            <td class="bid_qty"></td>
            <td class="ask_qty"></td>
            <td class="position"></td>
            <td class="paid"></td>
            <td class="value"></td>
            <td class="unrealized_pnl"></td>
            <td class="total_pnl"></td>
        </tr>
    
</div>  
  
</body>
</html>
