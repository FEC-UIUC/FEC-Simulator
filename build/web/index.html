<html>
<head>
<title>Financial Engineering Club at Illinois | FEC | Home</title>
<link href='http://fonts.googleapis.com/css?family=Roboto+Slab:400,300,700,100' rel='stylesheet' type='text/css'>
<!-- <link href='http://fec.ec.illinois.edu/main/css/style.css' rel='stylesheet' type='text/css'> -->
<link href='css/include/jquery.dataTables.min.css' rel='stylesheet' type='text/css'>
<style>
    .order-entry-col{
        float: left;
    }
    
    .form-row {
        clear: left;
    }
    
    .form-col {
        float: left;
        top: 0pt;
        height: 100%;
    }
    
    table {
        font-size:70%; 
        table-layout: fixed;
        text-align: center;
    }
    
    .scroll-y-area{
        overflow-y: scroll;
    }
    
    .cell-button{
        font-size:70%;
    }
    
    
    
</style>
<!--<script src="//code.jquery.com/jquery-1.11.0.min.js"></script>
<script src="//code.jquery.com/jquery-migrate-1.2.1.min.js"></script> -->
<script src="js/include/jquery-1.11.2.min.js"></script>
<script src="js/include/jquery-migrate-1.2.1.min.js"></script>
<script src="js/include/jquery.dataTables.min.js"></script>
<script src="js/include/highstock.js"></script>
<script src="js/include/modules/exporting.js"></script>
<script src="js/security_chart.js"></script>
<script>
        

        var CHAT_WINDOW_CHAR_LENGTH = 40;
        
        var webSocket;
        var messages;
        var username = "rickjames123";
        var _money = 0;
        var next_orderID = 1;
        var next_algorithm_id = 1;
        
        var securities = {};
        var orders = {};
        var algorithms = {};
        
        var validAlgorithmExtensions = ["py", "pyx"];
        
        $(function(){
            $('#header').load("http://fec.ec.illinois.edu/header.php");
            messages = document.getElementById("messages");
            openSocket();
            makeChart();
            //$("#securities-table").DataTable();
            //$("#current-orders-table").DataTable();
        });

        function openSocket(){
            if(webSocket !== undefined && webSocket.readyState !== WebSocket.CLOSED){
               writeResponse("WebSocket is already opened.");
               return;
            }

            webSocket = new WebSocket("ws://localhost:8080/Simulator/server");

            webSocket.onopen = function(event){
                    sendNewUser();
                    if(event.data === undefined)
                            return;
                    writeResponse(event.data);       
            };

            webSocket.onmessage = messageHandler;

            webSocket.onclose = function(event){
                writeResponse("Connection closed");
            };
            
        }
        
        function closeSocket(){
            webSocket.close();
        }
        
        function messageHandler(event){
            var msg = parseMessage(event.data);
            if(msg['message_type'] === 'message'){
                handleChatMessage(msg);
            } 
            else if (msg['message_type'] == 'order'){
                handleOrder(msg);
            } 
            else if (msg['message_type'] =='cancel'){
                handleCancel(msg);
            } 
            else if (msg['message_type'] =='snapshot'){
                handleSnapshot(msg);
            }
            else if (msg['message_type'] == 'new_user'){
                handleNewUser(msg);
            }
        }
        
        function parseMessage(message_string) {
            var message = {};
            var pairs = message_string.split("|");
            for(var i=0; i < pairs.length; i++){
                var key_val = pairs[i].split("=", 2);
                message[key_val[0]] = key_val[1];
            }
            return message;
        }
        
        function formatMessage(message_map) {
            var message_string = "";
            for(var key in message_map){
                message_string += key + "=" + message_map[key] + "|";
            }
            return message_string.slice(0, -1);
        }
        
        function send(msg){
            webSocket.send(formatMessage(msg));
        }

        function startData(){
           webSocket.send("message_type=admin|command=start");
        }

        function stopData(){
           webSocket.send("message_type=admin|command=stop");
        }

        function sendChatMessage(){
                var message_text = $("#messageinput").val();
                msg = {
                    "message_type" : "message",
                    "from" : username,
                    "message" : message_text
                }
                send(msg);
                $("#messageinput").val("");
        }
        
        function handleChatMessage(msg) {
            var m = "<b>" + msg['from'] + ":</b> " + msg['message']; 
            writeResponse(m);
        }

        

        function writeResponse(text){
            if(text.length > CHAT_WINDOW_CHAR_LENGTH){
                var remaining = text.slice(CHAT_WINDOW_CHAR_LENGTH);
                messages.innerHTML += "<br/>" + text.slice(0, CHAT_WINDOW_CHAR_LENGTH);
                writeResponse(remaining);
            } else {
                messages.innerHTML += "<br/>" + text;
            }
        }

        function clearFeed(){
            messages.innerHTML = "<br/>" 
        }
        
        
        function sendNewUser() {
            var message = {
                'message_type' : "new_user",
                'username' : username
            }
            send(message);
        }
        
        
        function handleNewUser(msg){
            var money = parseInt(msg['money']);
            setMoney(money);
            $("#username-span").html(username);
        }


        function sendOrder(symbol){
            var security = securities[symbol];
            var security_row = security["tablepointer"];
            var quantity = security_row.find(".quantity").find("input").val();
            var price = Math.round(security_row.find(".price").find("input").val()*100);
            var side_input = security_row.find(".side").find("select");
            var BS = side_input[0].options[side_input[0].selectedIndex].value;
            var order_type_input = security_row.find(".order-type").find("select");
            var order_type = order_type_input[0].options[order_type_input[0].selectedIndex].value;
            var orderID = next_orderID;
            var message = {
                "message_type" : "order",
                "symbol" : symbol,
                "price" : price,
                "side" : BS,
                "quantity" : quantity,
                "order_type" : order_type,
                "orderID" : orderID,
            }
            
            if(price > 0){
                webSocket.send(formatMessage(message));
                orders[orderID] = {
                    "orderID" : orderID,
                    "symbol" : symbol,
                    "price" : parseInt(price),
                    "side" : (parseInt(BS) == 0) ? "BUY" : "SELL",
                    "order_type" : (parseInt(order_type) == 0) ? "Market" : "Limit",
                    "filled" : 0,
                    "remaining" : parseInt(quantity),
                    "status" : "Pending",
                    "tablepointer" : null
                };
                updateOrdersTable(orders[orderID]);
            } else {
                writeResponse("Invalid Parameters for Order");
            }
            next_orderID++;            
        }
        

        function handleOrder(msg){

            if(!orders.hasOwnProperty(parseInt(msg["orderID"]))){
              writeResponse("Got order " + msg["orderID"] + ", what the hell.");
              return;
            }
            
            var security = securities[order["symbol"]];
            
            addMoney(parseInt(msg["money"]));
            
            order = orders[msg["orderID"]];
            order["remaining"] = parseInt(msg["remaining"]);
            order["filled"] += Math.abs(parseInt(msg["filled"]));
            
            security["paid"] += parseInt(msg["money"]);
             
            var side = (order["side"] == "BUY") ? 1 : -1;
            security['position'] += parseInt(msg["filled"]);
            var action = parseInt(msg["action"]);
            
            security['value'] = (security['position'] * security["last_price"])/100;
            security['total_pnl'] = (security['value'] - security['paid'])/100;
            
            if(action === 0){
                writeResponse("Order " + msg["orderID"] + " was filled for " + -1*side*msg["money"]/100);
                order["status"] = "Filled";
            } 
            else if(action === 1){
                writeResponse("Order " + msg["orderID"] + " was partially filled for " + -1*side*msg["money"]/100 + " and has " + msg["remaining"] + " remaining");
                order["status"] = "Partial Filled";
            } 
            else if(action === 2){
                writeResponse("Order " + msg["orderID"] + " was successfully placed");
                order["status"] = "Resting";
            } 
            else if(action === 3){
                writeResponse("Order " + msg["orderID"] + " was canceled");
                order["status"] = "Canceled";
            }
            
            orders[msg["orderID"]] = order;
            
            updateOrdersTable(order);
            
        }


        function sendCancel(orderID){
            if(orderID != null){
                writeResponse("Sending cancel order for " + orderID);
                var msg = {
                    "message_type" : "cancel",
                    "orderID" : orderID
                }
                webSocket.send(formatMessage(msg));
            }
        }
        
        function handleCancel(msg){
            if(!orders.hasOwnProperty(msg["orderID"])){
                writeResponse("Got order " + msg["orderID"] + ", what the hell.");
                return;
            }
            if(msg["success"] == 0){
                writeResponse("Cancel Failed on order " + msg["orderID"]);
            } else if(msg["success"] == 1){
                writeResponse("Cancel Success on order " + msg["orderID"]);
                orders[msg["orderID"]]["status"] = "Canceled";
                updateOrdersTable(orders[msg["orderID"]]);
            }
        }

        var next_t = 0;
        var chart_security = "GOOG";
        function handleSnapshot(msg){

            if(!securities.hasOwnProperty(msg['symbol'])){
                securities[msg['symbol']] = {
                    'symbol' : "",
                    'price_series' : [],
                    'volume_series' : [],
                    'bid_price' : 0,
                    'ask_price' : 0,
                    'bid_qty' : 0,
                    'ask_qty' : 0,
                    "last_price" : 0,
                    'position' : 0,
                    'paid' : 0,
                    'value' : 0,
                    "total_pnl" : 0,
                    'tablepointer' : null
                };
            } 

            var t = (new Date()).getTime()
            var bid_price = parseInt(msg['bid_price']);
            var ask_price = parseInt(msg['ask_price']);
            var last_price = parseInt(msg['last_price']);
            var bid_qty = parseInt(msg['bid_qty']);
            var ask_qty = parseInt(msg['ask_qty']);
            var open_price = (bid_price+ask_price)/2 + (50 - Math.round(100*Math.random()));
            var close_price = (bid_price+ask_price)/2 + (50 - Math.round(100*Math.random()));
            
            var bar = [t, open_price/100, open_price/100, close_price/100, close_price/100];
            
            var security = securities[msg['symbol']];
            
            security['symbol'] = msg['symbol'];
            security['price_series'].push([t, bar]);
            security['volume_series'].push([t,bid_qty+ask_qty]);
            security['value'] = (security['position'] * last_price)/100;
            security['bid_price'] = bid_price/100;
            security['ask_price'] = ask_price/100;
            security['bid_qty'] = bid_qty;
            security['ask_qty'] = ask_qty;
            security['last_price'] = last_price/100;
            security['total_pnl'] = (security['value'] - security['paid'])/100; 
            
            updateSecurityTable(securities[msg['symbol']]);
            
            if(msg['symbol'] == chart_security){
                stockchart.series[0].addPoint(bar, true, false);
                stockchart.series[1].addPoint([t, bid_qty+ask_qty], true, false);
            }
        }
        
        
        var orderStatusStyleMap = {
            "Pending" : "background-color:grey;",
            "Resting" : "background-color:white;",
            "Partial Filled" : "background-color:yellow;",
            "Filled" : "background-color:green;",
            "Canceled" : "background-color:red;"
        }
        
        
        function updateOrdersTable(order){
            
            var order_row = order["tablepointer"]; 
            
            if(order_row == null){
                order_row = $("#templates").find(".current-orders-row").clone();
                order_row.attr("id", "order-row-" + order["orderID"].toString());
                order["tablepointer"] = order_row;
            }
            
            for(key in order){
              if(key != "status" && key != "tablepointer"){
                order_row.find("." + key).html(order[key]);   
              }
            }
            
            order_row.attr("style", orderStatusStyleMap[order["status"]]);
            
            if(order["status"] == "Filled" || order["status"] == "Canceled"){
                $("#past-orders-tbody").append(order_row);
                order_row.find(".cancel-order").remove("button");
                order_row.remove(".cancel-order");
            } else {
                $("#current-orders-tbody").append(order_row);
                var cancel_order_button = order_row.find(".cancel-order").find("button");
                cancel_order_button.click(function(e){ sendCancel(order["orderID"]);});
            }
              
        }
        
        
        function removeFromOrdersTable(order, tbody){
            var order_row = order["tablepointer"];
            var order_row_id = "order-row-" + order["orderID"].toString();
            tbody.remove("#" + order_row_id);
        }

        
        function updateSecurityTable(security) {
            var security_row = security["tablepointer"];
            
            if (security_row == null) {
                security_row = $("#templates").find(".securities-row").clone();
                security_row.attr("id", "security-row-" + security["symbol"]); 
                var order_button = security_row.find(".order").find("button");
                order_button.click(function(e){ sendOrder(security["symbol"]);});  
                security["tablepointer"] = security_row;
                $("#securities-tbody").append(security_row);
            }
            
            for(key in security){
              if(key != "price_series" && key != "volume_series" && key != "tablepointer" && key != "paid"){
                security_row.find("." + key).html(security[key]);   
              }
            } 
        }
        
        
        function removeFromSecuritiesTable(security){
            var security_row_id = "securities-row-" + security["symbol"].toString();
            $("#securities-tbody").remove("#" + security_row_id);
        }
        
        
        function setMoney(val){
            _money = val;
            $("#money-span").html(_money);
        }
        
        function addMoney(val){
            _money += val;
            $("#money-span").html(_money);
        }
        
        
        function addAlgorithm(){
            var algo_name = $("#algorithm-name").val();
            var filename = $("#algorithm-browse").val();
            if(validAlgorithmExtensions.indexOf(filename.split(".").pop()) == -1){
               alert("Invalid file extension.  File must be a Python file.");
               return;
            }
            if(algo_name == ""){
                algo_name = filename.split(".")[0];
            }
            var new_algorithm = {
                "id" : next_algorithm_id,
                "name" : algo_name,
                "file" : filename,
                "securities" : [],
                "parameters" : {},
                "status" : "running",
                "PnL" : 0,
                "log-file" : "log/user_logs/" + username + "/" + algo_name.replace(" ", "_") + ".log",
                "tablepointer" : null
            };
            algorithms[next_algorithm_id] = new_algorithm;
            next_algorithm_id++;
            if(uploadAlgorithm(new_algorithm)){
                updateAlgorithmTable(new_algorithm);
            }
        }
        
        
        function uploadAlgorithm(algorithm) {
            return true;
        }
        
        
        function runAlgorithm(algorithm){
            
        }
        
        
        function stopAlgorithm(algorithm){
            
        }
        
        
        function removeAlgorithm(algorithm){
            removeAlgorithmFromTable(algorithm);
            delete algorithms[algorithm["id"]];
        }
        
        
        function editAlgorithmParameters(algorithm) {
            
        }
        
        
        function editAlgorithmSecurities(algorithm) {
            
        }
        
        
        var algorithmStatusStyleMap = {
            "stopped" : "background-color:light-grey;",
            "running" : "background-color:light-green;",
            "error" : "background-color:red;"
        }
        
        
        function updateAlgorithmTable(algorithm) {
            var algorithm_row = algorithm["tablepointer"];
            
            if (algorithm_row == null) {
                algorithm_row = $("#templates").find(".algorithms-row").clone();
                algorithm_row.attr("id", "algorithms-row-" + algorithm["id"]); 
                
                var run_button = algorithm_row.find(".run").find("button");
                run_button.click(function(e){ runAlgorithm(algorithm);});
                
                var stop_button = algorithm_row.find(".stop").find("button");
                stop_button.click(function(e){ stopAlgorithm(algorithm);});  
                
                var remove_button = algorithm_row.find(".remove").find("button");
                remove_button.click(function(e){ removeAlgorithm(algorithm);});
                
                var securities_button = algorithm_row.find(".securities").find("button");
                securities_button.click(function(e){ editAlgorithmSecurities(algorithm);});  
                
                var parameters_button = algorithm_row.find(".parameters").find("button");
                parameters_button.click(function(e){ editAlgorithmParameters(algorithm);});
                
                var log_button = algorithm_row.find(".log").find("a");
                log_button.attr("href", algorithm["log"]);
                
                algorithm["tablepointer"] = algorithm_row;
                $("#algorithms-tbody").append(algorithm_row);
            }
            
            for(key in algorithm){
              if(key != "tablepointer" && key != "securities" && key != "parameters" && key != "file"){
                algorithm_row.find("." + key).html(algorithm[key]);   
              }
            }
            
            algorithm_row.attr("style", algorithmStatusStyleMap[algorithm["status"]]);
              
        }
        
        
        function removeFromAlgorithmTable(algorithm){
            var algorithm_row_id = "algorithms-row-" + algorithm["id"].toString();
            $("#algorithms-tbody").remove("#" + algorithm_row_id);
        }
        
        
	</script>
</head>
<body>
  <div id="header"></div>
  <div id="content">
  
  <div class="form-col" style="width:16%;height:100%;">
    <div class="form-row" style="height:10%;">
        Username: <span id="username-span"></span>
        <br>
        Money: <span id="money-span"></span>
    </div>
   
      
    <div class="form-row" style="height:90%;">
        
        <div class="form-row" style="height:10%;">
            <button type="button" onclick="openSocket();" >Open</button>
            <button type="button" onclick="closeSocket();" >Close</button> <br>
            <button type="button" onclick="startData();" >Start</button>
            <button type="button" onclick="stopData();" >Stop</button>
            
        </div>

        <div id="chat-area" class="form-row" style="height:90%;">
          <label for="messageinput">Message</label>
          <input type="text" id="messageinput"/>
          <br>
          <button type="button" onclick="sendChatMessage();" >Send Message</button>            
          <button type="button" onclick="clearFeed();" >Clear Feed</button>
          <br>
          <!-- Server responses get written here -->
          <div id="messages" class="scroll-y-area" style="height:90%;"></div>
        </div>
        
    </div>
      
  </div>
  
  
  <div class="form-col" style="width:84%;">
     
        <div class="form-row" style="height:35%;">
            <div class="scroll-y-area" style="width:64%;float:left;">
                <table id="securities-table" class="display" style="margin-left:auto;margin-right:auto;font-size:70%; table-layout: fixed;" cellspacing="3">
                    <thead><th>Symbol</th> <th>Order</th> <th> Quantity </th> <th>Price</th> <th>Side</th> <th>Order <br> Type</th> <th>Last</th> <th>Best Bid</th> <th>Best Ask</th> <th>Bid Qty</th> <th>Ask Qty</th> 
                    <th>Position</th> <th>Value</th> <th>Total P&L</th> </thead>
                    <tbody id="securities-tbody"></tbody>
                </table>
            </div>
            
            <div class="form-col" style="width:35%; padding-left: 1%; float:left; ">

              <label for="algorithm-name">Name</label>
              <input type="text" id="algorithm-name"/> &nbsp;
              <input type="file" id="algorithm-browse" name="Browse" /> <br>
              <button type="button" id="algorithm-upload" name="Upload" onclick="addAlgorithm();">Upload Algorithm</button>

              <br>

              <div class="scroll-y-area" style="margin-left:auto;margin-right:auto;height:60%;">
                  <table id="algorithms-table" class="display" style="margin-left:auto;margin-right:auto; float:left; font-size:70%; table-layout: fixed; border: solid black;" cellspacing="4">
                      <thead> <th>Id</th> <th>Name</th> <th>Securities</th> <th>Parameters</th> <th>Status</th> <th>Run</th> <th>Stop</th> <th>Remove</th> <th>P&L</th> <th>Log</th></thead>
                      <tbody id="algorithms-tbody"></tbody>
                  </table>
              </div>

            </div>
            
        </div>

        
      
        <div class="form-row" style="height:65%;">
        
            <div class="form-col" style="width:32%;">
                <div class="scroll-y-area" style="padding-left:2%; margin-left:auto;margin-right:auto;height:52%;">
                    <table id="current-orders-table" class="display" style="float:left; font-size:70%; table-layout: fixed; border: solid black;" cellspacing="3">
                        <thead><th>OrderID</th> <th>Symbol</th> <th>Side</th> <th>Order Type</th> <th>Price</th> <th>Remaining</th> <th>Filled</th></thead>
                        <tbody id="current-orders-tbody"></tbody>
                    </table>
                </div>

                <br>

                <div class="scroll-y-area" style="padding-left:2%; margin-left:auto;margin-right:auto;height:40%;">
                    <table id="past-orders-table" class="display" style="float:left; font-size:70%; table-layout: fixed; border: solid black;" cellspacing="3">
                        <thead><th>OrderID</th> <th>Symbol</th> <th>Side</th> <th>Order Type</th> <th>Price</th> <th>Remaining</th> <th>Filled</th></thead>
                        <tbody id="past-orders-tbody"></tbody>
                    </table>
                </div>
            </div>
            
            <div class="scroll-y-area" style="padding-left:1%; height:100%;width:67%;float:left;">
                <div id="chart-area" style="height:90%;width:95%;"> </div> 
            </div>
        
        </div>
       
      
  </div>
     

  
      
      
  </div>
    

 
 
  
<div id="templates" style="display:none;">
    
    <table>
        <tbody>
            <tr class="current-orders-row">
                <td class="orderID"></td>
                <td class="symbol"></td>
                <td class="side"></td>
                <td class="order_type"></td>
                <td class="price"></td>
                <td class="remaining"></td>
                <td class="filled"></td>
                <td class="cancel-order">
                    <button type="button">Cancel</button>
                </td>
            </tr>
        </tbody>
    </table>
        
    <table>
        <tbody>
        <tr class="securities-row">
            <td class="symbol"></td>
            <td class="order">
                <button type="button">Order</button>
            </td>
            <td class="quantity">
                <input type="number" style="width:90;"/>
            </td>
            <td class="price"  >
                <input type="number" style="width:90;"/>
            </td>
            <td class="side">
                <select id="side" size="1">
                    <option selected="selected" value="0">Buy</option>
                    <option value="1">Sell</option>
                </select>
            </td>
            <td class="order-type">
                <select id="order-type" size="1">
                    <option value="0">Market</option>
                    <option selected="selected" value="1">Limit</option>
                </select>
            </td>
            <td class="last_price"></td>
            <td class="bid_price"></td>
            <td class="ask_price"></td>
            <td class="bid_qty"></td>
            <td class="ask_qty"></td>
            <td class="position"></td>
            <td class="value"></td>
            <td class="total_pnl"></td>
        </tr>
      </tbody>
    </table>
    
    <table>
        <tbody>
            <tr class="algorithms-row">
                <td class="id"></td>
                <td class="name"></td>
                <td class="securities">
                    <button class="cell-button" type="button" style="font-size:50%;">Edit</button>
                </td>
                <td class="parameters">
                    <button class="cell-button" type="button" style="font-size:50%;">Edit</button>
                </td>
                <td class="status"></td>
                <td class="run">
                    <button class="cell-button" type="button" style="font-size:50%;">Run</button>
                </td>
                <td class="stop">
                    <button class="cell-button" type="button" style="font-size:50%;">Stop</button>
                </td>
                <td class="remove">
                    <button class="cell-button" type="button" style="font-size:50%;">Rem</button>
                </td>
                <td class="PnL"></td>
                <td class="Log">
                    <a href="" download>Log</a>
                </td>
            </tr>
        </tbody>
    </table>
    
</div>  
  
</body>
</html>
